apiVersion: batch/v1
kind: Job
metadata:
  name: backtest-{{RUN_ID}}
  labels:
    app: backtest
    run-id: "{{RUN_ID}}"
spec:
  # Run pods in parallel (one per trading day)
  # Set to {{PARALLELISM}} - will be replaced by submit script
  parallelism: {{PARALLELISM}}
  completions: {{COMPLETIONS}}
  completionMode: Indexed
  backoffLimit: 3  # Retry failed pods up to 3 times

  template:
    metadata:
      labels:
        app: backtest-worker
        run-id: "{{RUN_ID}}"
    spec:
      restartPolicy: Never

      # No image pull secret needed for public Docker Hub image
      # imagePullSecrets:
      # - name: ocir-secret

      containers:
      - name: backtest
        image: python:3.11-slim
        imagePullPolicy: IfNotPresent

        # Use inline script to bootstrap
        command: ["/bin/bash"]
        args:
        - "-c"
        - |
          set -e
          echo "Installing OCI SDK..."
          pip install --quiet oci

          echo "Downloading code from OCI..."
          python3 << 'PYEOF'
          import os
          import tarfile
          from pathlib import Path
          import oci

          config = oci.config.from_file()
          os_client = oci.object_storage.ObjectStorageClient(config)
          namespace = os_client.get_namespace().data
          bucket = os.environ.get('OCI_BUCKET_CODE', 'backtest-code')
          run_id = os.environ.get('RUN_ID')

          print(f"Downloading: {run_id}/code.tar.gz")
          get_obj = os_client.get_object(
              namespace_name=namespace,
              bucket_name=bucket,
              object_name=f"{run_id}/code.tar.gz"
          )

          tarball_path = Path('/tmp/code.tar.gz')
          with open(tarball_path, 'wb') as f:
              for chunk in get_obj.data.raw.stream(1024 * 1024, decode_content=False):
                  f.write(chunk)

          app_dir = Path('/app')
          app_dir.mkdir(parents=True, exist_ok=True)

          with tarfile.open(tarball_path, 'r:gz') as tar:
              tar.extractall(path=app_dir)

          print(f"Code extracted to /app")
          PYEOF

          echo "Running entrypoint..."
          cd /app
          python3 oci/docker/entrypoint_runtime.py

        # Resource limits (2 CPU, 8 GB RAM per pod)
        resources:
          requests:
            cpu: "2"
            memory: "8Gi"
          limits:
            cpu: "2"
            memory: "8Gi"

        # Environment variables
        env:
        # Pod index (0-119) - each pod processes one date
        - name: JOB_COMPLETION_INDEX
          valueFrom:
            fieldRef:
              fieldPath: metadata.annotations['batch.kubernetes.io/job-completion-index']

        # Run ID for organizing results
        - name: RUN_ID
          value: "{{RUN_ID}}"

        # OCI Object Storage buckets
        - name: OCI_BUCKET_CACHE
          value: "backtest-cache"

        - name: OCI_BUCKET_CODE
          value: "backtest-code"

        - name: OCI_BUCKET_RESULTS
          value: "backtest-results"

        # Comma-separated list of dates (pod uses index to pick its date)
        - name: DATES_LIST
          value: "{{DATES_LIST}}"

        # OCI region
        - name: OCI_REGION
          value: "ap-mumbai-1"

        # Configuration hash (for cache versioning)
        - name: CONFIG_HASH
          value: "{{CONFIG_HASH}}"

        # Working directory
        workingDir: /app

        # Health checks (optional, helps Kubernetes detect stuck pods)
        livenessProbe:
          exec:
            command:
            - sh
            - -c
            - "pgrep -f python || exit 1"
          initialDelaySeconds: 60
          periodSeconds: 300
          timeoutSeconds: 30
          failureThreshold: 3
